/**
 * @fileoverview Firestore Security Rules for the LegallyAI platform.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-specific data
 * while providing public read access to law firm and lawyer data.
 * It uses a database-centric access control (DBAC) approach for administrative roles.
 *
 * Data Structure:
 * - /users/{userId}: Stores user data; access is restricted to the owning user.
 * - /userProfiles/{profileId}: Stores user profile data; access is open.
 * - /lawFirms/{lawFirmId}: Stores law firm data; read access is public, write access is restricted.
 * - /lawyers/{lawyerId}: Stores lawyer data; read access is public, write access is restricted.
 * - /consultations/{consultationId}: Stores consultation data; write access is restricted.
 * - /engagements/{engagementId}: Stores engagement data; write access is restricted.
 * - /roles_admin/{userId}: Stores admin user IDs. Existence of the document grants admin access.
 *
 * Key Security Decisions:
 * - Users can only read/write their own data under /users/{userId}.
 * - User profiles are publicly readable.
 * - Law firm and lawyer data are publicly readable.
 * - Administrative privileges are determined by the presence of a document in the /roles_admin/{userId} collection.
 * - Data validation is minimized in the prototyping phase to allow for rapid iteration.
 *
 * Denormalization for Authorization:
 * The 'profileId' is stored directly in the User document to avoid needing to read the /userProfiles collection to determine access.
 */

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     * @return {bool} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the current user is the owner of the resource.
     * @param {string} userId The user ID to check against.
     * @return {bool} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the current user is the owner of the resource and it exists.
     *              This function is used for update and delete operations.
     * @param {string} userId The user ID to check against.
     * @return {bool} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the current user is an admin.
     * @return {bool} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
        return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Rules for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' creates their own user document.
     *    - request.auth.uid: 'user123'
     *    - resource.data.id: 'user123'
     * @deny (create) User with ID 'user123' tries to create a user document for 'user456'.
     *    - request.auth.uid: 'user123'
     *    - resource.data.id: 'user456'
     * @principle Enforces document ownership for writes and validates relational integrity.
     */
    match /users/{userId} {
      // Read rules: Only the owner can read their own user document.
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      // Write rules: Only the owner can create, update, or delete their own user document.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /userProfiles/{profileId} collection.
     * @path /userProfiles/{profileId}
     * @allow (read) Any user can read any user profile.
     * @allow (write) The owner of the profile can write to it.
     * @principle Allows public read access and owner-only write access.
     */
    match /userProfiles/{profileId} {
      allow read: if true;
      allow create, update, delete: if request.auth != null && request.auth.uid == profileId;
    }

    /**
     * @description Rules for the /lawFirms/{lawFirmId} collection.
     * @path /lawFirms/{lawFirmId}
     * @allow (get, list) Any user can read any law firm data.
     * @deny (create, update, delete) Only admins can create, update or delete law firms.
     * @principle Allows public read access and admin only write access.
     */
    match /lawFirms/{lawFirmId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Rules for the /lawyers/{lawyerId} collection.
     * @path /lawyers/{lawyerId}
     * @allow (get, list) Any user can read any lawyer data.
     * @deny (create, update, delete) Only admins can create, update or delete lawyers.
     * @principle Allows public read access and admin only write access.
     */
    match /lawyers/{lawyerId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Rules for the /consultations/{consultationId} collection.
     * @path /consultations/{consultationId}
     * @deny (create, update, delete) Only admins can create, update or delete consultations.
     * @principle Restricts write access to admins only.
     */
    match /consultations/{consultationId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Rules for the /engagements/{engagementId} collection.
     * @path /engagements/{engagementId}
     * @deny (create, update, delete) Only admins can create, update or delete engagements.
     * @principle Restricts write access to admins only.
     */
    match /engagements/{engagementId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

        /**
     * @description Rules for the /roles_admin/{userId} collection.
     * @path /roles_admin/{userId}
     */
    match /roles_admin/{userId} {
          allow get: if isAdmin();
          allow list: if isAdmin();
          allow create: if isAdmin();
          allow update: if false;
          allow delete: if isAdmin();
    }
  }
}
